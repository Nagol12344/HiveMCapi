name: Publish Python ðŸ distributions ðŸ“¦ to PyPI and TestPyPI

on: push

jobs:
  build-n-publish:
    name: Build and publish Python ðŸ distributions ðŸ“¦ to PyPI and TestPyPI
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@master
    - name: Set up Python 3.9
      uses: actions/setup-python@v1
      with:
        python-version: 3.9
    - name: Install pypa/build
      run: >-
        python -m
        pip install
        setuptools
        wheel
        --user
    - name: Build a binary wheel and a source tarball
      run: >-
        python setup.py bdist_wheel
        python setup.py sdist
        ## Get the file name of the wheel
        WHEEL_FILE=$(ls dist/*.whl)
        ## Get the file name of the source tarball
        SOURCE_TAR_FILE=$(ls dist/*.tar.gz)
        ## Get the last file name of the wheel from https://test.pypi.org/project/hivemcapi/#files
        LAST_WHEEL_FILE=$(curl -s https://test.pypi.org/project/hivemcapi/ | grep -oE 'hivemcapi-[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl' | tail -n 1)
        ## Get what version the last wheel file is
        LAST_WHEEL_VERSION=$(echo $LAST_WHEEL_FILE | grep -oE '[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl' | grep -oE '[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl' | grep -oE '[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl' | grep -oE '[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl' | grep -oE '[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl' | grep -oE '[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl' | grep -oE '[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl' | grep -oE '[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl' | grep -oE '[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl' | grep -oE '[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl' | grep -oE '[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl' | grep -oE '[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl' | grep -oE '[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl' | grep -oE '[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl' | grep -oE '[0-9.]+-[0-9.]+
        ## Up the number of the last wheel file
        NEW_WHEEL_FILE=$(echo $LAST_WHEEL_FILE | sed 's/[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl/'$(echo $LAST_WHEEL_VERSION | sed 's/[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl/'$(echo $LAST_WHEEL_VERSION | sed 's/[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl/'$(echo $LAST_WHEEL_VERSION | sed 's/[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl/'$(echo $LAST_WHEEL_VERSION | sed 's/[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl/'$(echo $LAST_WHEEL_VERSION | sed 's/[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl/'$(echo $LAST_WHEEL_VERSION | sed 's/[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl/'$(echo $LAST_WHEEL_VERSION | sed 's/[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl/'$(echo $LAST_WHEEL_VERSION | sed 's/[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl/'$(echo $LAST_WHEEL_VERSION | sed 's/[0-9.]+-[0-9.]+-py[0-9.]+-none-any.whl/'$(echo $LAST_WHEEL_VERSION | sed 's/[0-9.]+-[0-9.]+-py
        mv $LAST_WHEEL_FILE $NEW_WHEEL_FILE
        ## Do the same for the source tarball
        mv $SOURCE_TAR_FILE $NEW_WHEEL_FILE.tar.gz
        
    - name: Publish distribution ðŸ“¦ to Test PyPI
      if: "!contains(github.event.head_commit.message, 'BULID')"
      uses: pypa/gh-action-pypi-publish@master
      with:
        password: ${{ secrets.TEST_PYPI_API_TOKEN }}
        repository_url: https://test.pypi.org/legacy/
    - name: Publish distribution ðŸ“¦ to PyPI
      if: "contains(github.event.head_commit.message, 'BULID')"
      uses: pypa/gh-action-pypi-publish@master
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
